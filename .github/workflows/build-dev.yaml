name: CI/CD - Build & Push (Branch DEV)
on:
  push:
    branches:
      - dev
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: upebr/consultas
  JAVA_VERSION: '21'
  COMMIT_SHA_SHORT: ${{ github.sha }}
  MAVEN_CACHE_KEY: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}

jobs:
  build_and_push:
    name: Build, Test, and Push to Docker Hub
    runs-on: ubuntu-latest

    environment: dev
    
    steps:
      - name: Checkout do CÃ³digo
        uses: actions/checkout@v4

      - name:  Define Short Commit SHA
        id: set_sha
        run: echo "DOCKER_TAG_FULL=${{ steps.set_sha.outputs.sha_short }}-dev" >> $GITHUB_OUTPUT
        outputs:
          sha_short: ${{ substring(github.sha, 0, 7) }}

      - name: Configurar Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Build e Teste com Maven
        run: |
          mvn clean package -DskipTests
          # Rodar testes de unidade (opcional, mas recomendado)
          # mvn test

      #todo: adicionar as secrets DOCKER_USERNAME e DOCKER_PASSWORD no repo
      - name: Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Construir a Imagem Docker (Multi-Stage)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.set_sha.outputs.sha_short }}-dev